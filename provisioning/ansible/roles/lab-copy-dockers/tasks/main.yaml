- name: Synchronize dockerfiles from local directory
  ansible.posix.synchronize:
    src: ../../services
    dest: "{{ lab_dir }}/"

- name: Render the Jinja2 template for Traefik
  ansible.builtin.template:
    src: ../../services/traefik/traefik.yml.j2
    dest: "{{ lab_dir }}/services/traefik/traefik.yml"
    mode: '0644'

- name: Render the Jinja2 template for Perplexica
  ansible.builtin.template:
    src: ../../services/dockge/stacks/lab-llm-perplexica/perplexica/config.toml.j2
    dest: "{{ lab_dir }}/services/dockge/stacks/lab-llm-perplexica/perplexica/config.toml"
    mode: '0644'

- name: Render the Jinja2 template for Grafana
  ansible.builtin.template:
    src: ../../services/docker-compose.grafana.yaml.j2
    dest: "{{ lab_dir }}/services/docker-compose.grafana.yaml"
    mode: '0644'

- name: Render the Jinja2 template for Casdoor
  ansible.builtin.template:
    src: ../../services/docker-compose.casdoor.yaml.j2
    dest: "{{ lab_dir }}/services/docker-compose.casdoor.yaml"
    mode: '0644'

- name: Render the Jinja2 template for Dockge
  ansible.builtin.template:
    src: ../../services/docker-compose.dockge.yaml.j2
    dest: "{{ lab_dir }}/services/docker-compose.dockge.yaml"
    mode: '0644'

- name: Cleanup the Jinja2 templates
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ lab_dir }}/services/traefik/traefik.yml.j2"
    - "{{ lab_dir }}/services/dockge/stacks/lab-llm-perplexica/perplexica/config.toml.j2"
    - "{{ lab_dir }}/services/docker-compose.grafana.yaml.j2"
    - "{{ lab_dir }}/services/docker-compose.casdoor.yaml.j2"
    - "{{ lab_dir }}/services/docker-compose.dockge.yaml.j2"
