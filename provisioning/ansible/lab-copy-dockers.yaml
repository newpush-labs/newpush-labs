- name: Copy Docker images to hosts
  hosts: lab
  remote_user: root
  pre_tasks:
    - name: Get client secret from casdoor
      ansible.builtin.command: python3 /opt/student-lab/utils/casdoor/casdoor-rotate-secrets.py --db /opt/student-lab/services/casdoor/casdoor.db
      register: cmd_casdoor_rotate_secrets
      changed_when: false
      failed_when: false

    - name: Extract Client Secret
      ansible.builtin.set_fact:
        generic_oauth_client_secret: "{{ cmd_casdoor_rotate_secrets.stdout_lines \
                                             | select('search', 'Client Secret: ') \
                                             | map('regex_replace', '^.*Client Secret: ', '') \
                                             | first }}"

  roles:
    # - common
    - lab-copy-installer
    - lab-copy-dockers
    - lab-set-permissions
