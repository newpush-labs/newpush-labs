- name: Setup lab
  hosts: lab
  remote_user: root
  roles:
    - {role: common, tags: [always]}
    - {role: lab-install-docker, tags: [setup]}
    - {role: lab-user, tags: [setup]}
    - {role: lab-copy-installer, tags: [setup]}
    - {role: lab-configure-casdoor, tags: [setup]}
    - {role: lab-copy-dockers, tags: [setup]}
    - {role: lab-configure-env, tags: [setup]}
    - {role: lab-set-permissions, tags: [setup]}
    - {role: lab-utils-tty2web, tags: [setup]}
  tasks:
    - name: Run newpush-lab to migrate
      ansible.builtin.command:
        cmd: /usr/local/bin/newpush-lab migrate
      tags:
        - always
      
    - name: Run newpush-lab to recreate
      ansible.builtin.command:
        cmd: /usr/local/bin/newpush-lab recreate
      tags:
        - always

    # Configure security after CrowdSec is installed and running
    - name: Configure security
      include_role:
        name: lab-configure-security
      tags:
        - setup
    
    # Run newpush-lab to restart after security configuration
    - name: Run newpush-lab to restart
      ansible.builtin.command:
        cmd: /usr/local/bin/newpush-lab restart
      tags:
        - always

    # Modular Stacks Deployment
    - name: Start modular stacks
      ansible.builtin.command:
        cmd: "/usr/local/bin/newpush-lab start {{ item.name }}"
      loop: "{{ lab_active_stacks | default([]) }}"
      tags:
        - always
